AWSTemplateFormatVersion: 2010-09-09
Description: >-
  devops-toolkit-api
Transform:
- AWS::Serverless-2016-10-31

Parameters:

  Environment:
    Type: String

  LoginCFStackName:
    Type: String

  Route53AppDomainName:
    Type: String

  AllowedCorsDomains:
    Type: String
    Description: Define allowed client UI domains here. Use commas to separate if multiple.

  FilteredComplianceRulesParamName:
    Type: String
    Description: SSM param key name which defines AWS Config compliance rules in string array

  AppLoggingLevel:
    Type: String
    AllowedValues: [TRACE, DEBUG, INFO, WARN, ERROR, FATAL]
    Default: INFO

  SystemLogLevel:
    Type: String
    AllowedValues: [DEBUG, INFO, WARN]
    Default: INFO

  WhitelistIPs:
    Type: CommaDelimitedList
    Description: Allow specific IP ranges outside of WAF Geoblocked zone
    Default: "127.0.0.1/32" # A dummy value

Resources:

  AuditSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: !Sub ${AWS::StackName}-AuditSNSTopic
      Subscription:
        - Protocol: lambda
          Endpoint: !GetAtt WriteAuditFunction.Arn

  SNSAuditInvokePermission:
    Type: 'AWS::Lambda::Permission'
    Properties:
      Action: 'lambda:InvokeFunction'
      FunctionName: !Ref WriteAuditFunction
      Principal: sns.amazonaws.com
      SourceAccount: !Sub ${AWS::AccountId}

  BasicLambdaExcecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

  CFLambdaExcecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-CFPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: CFPolicy
                Effect: Allow
                Action:
                  - cloudformation:CreateChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                  - cloudformation:ListStacks
                  - cloudformation:UpdateStack
                  - cloudformation:DescribeStacks
                  - cloudformation:DescribeStackResources
                  - cloudformation:DetectStackDrift
                  - cloudformation:DetectStackResourceDrift
                  - cloudformation:DescribeStackResourceDrifts
                Resource: "*"
              - Sid: SsmParametersPolicy
                Effect: Allow
                Action:
                  - ssm:GetParameter*
                Resource: "*"
              - Sid: SNSPolicy
                Effect: Allow
                Action:
                  - sns:publish
                Resource: !Ref AuditSNSTopic
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

  SSMParamsLambdaExcecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-SSMPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SsmParametersPolicy
                Effect: Allow
                Action:
                  - ssm:GetParameter*
                  - ssm:PutParameter*
                  - ssm:DescribeParameters
                Resource: "*"
              - Sid: SNSPolicy
                Effect: Allow
                Action:
                  - sns:publish
                Resource: !Ref AuditSNSTopic
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

  ConfigServiceLambdaExcecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-SSMPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: ConfigPolicy
                Effect: Allow
                Action:
                  - config:DescribeConfig*
                  - config:DescribeCompliance*
                  - config:DescribeRemediationExecutionStatus
                  - config:GetCompliance*
                  - config:GetResourceEvaluationSummary
                Resource: "*"
              - Sid: SsmParametersPolicy
                Effect: Allow
                Action:
                  - ssm:GetParameter*
                Resource: !Sub "arn:aws:ssm:*:${AWS::AccountId}:parameter${FilteredComplianceRulesParamName}"
              - Sid: DynamoDbPolicy
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:DescribeTable
                  - dynamodb:DeleteItem
                  - dynamodb:GetItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt ConfigNonCompliantRuleTable.Arn
                  - !GetAtt ConfigNonCompliantRuleCountsTable.Arn

      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

  ApplicationErrorServiceLambdaExcecutionRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: !Sub ${AWS::StackName}-SSMPolicies
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: SsmParametersPolicy
                Effect: Allow
                Action:
                  - ssm:GetParameter*
                Resource: !Sub "arn:aws:ssm:*:${AWS::AccountId}:parameter${FilteredComplianceRulesParamName}"
              - Sid: DynamoDbPolicy
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:DescribeTable
                  - dynamodb:DeleteItem
                  - dynamodb:GetItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:UpdateItem
                Resource:
                  - !GetAtt ApplicationErrorConfigTable.Arn
                  - !GetAtt ApplicationErrorCodeTable.Arn

      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"

  ApplicationErrorConfigTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: "ApplicationId"
          AttributeType: "S"
        - AttributeName: "Region"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "ApplicationId"
          KeyType: "HASH"
        - AttributeName: "Region"
          KeyType: "RANGE"
      BillingMode: PAY_PER_REQUEST
      #      ProvisionedThroughput:
      #        ReadCapacityUnits: 1
      #        WriteCapacityUnits: 1
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false # Set to true if protection is needed
  #      SSESpecification: # Enable for production environments
  #        SSEEnabled: true

  ApplicationErrorCodeTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: "ApplicationId"
          AttributeType: "S"
        - AttributeName: "ErrorCode"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "ApplicationId"
          KeyType: "HASH"
        - AttributeName: "ErrorCode"
          KeyType: "RANGE"
      BillingMode: PAY_PER_REQUEST
      #      ProvisionedThroughput:
      #        ReadCapacityUnits: 1
      #        WriteCapacityUnits: 1
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false # Set to true if protection is needed
  #      SSESpecification: # Enable for production environments
  #        SSEEnabled: true

  ConfigNonCompliantRuleCountsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: "Rule"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "Rule"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      #      ProvisionedThroughput:
      #        ReadCapacityUnits: 1
      #        WriteCapacityUnits: 1
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false # Set to true if protection is needed
#      SSESpecification: # Enable for production environments
#        SSEEnabled: true

  ConfigNonCompliantRuleTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: "Rule"
          AttributeType: "S"
        - AttributeName: "ResourceName"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "Rule"
          KeyType: "HASH"
        - AttributeName: "ResourceName"
          KeyType: "RANGE"
      BillingMode: PAY_PER_REQUEST
      #      ProvisionedThroughput:
      #        ReadCapacityUnits: 1
      #        WriteCapacityUnits: 1
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false # Set to true if protection is needed
#      SSESpecification: # Enable for production environments
#        SSEEnabled: true

  RetrieveApplicationErrorConfigsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 1
      LoggingConfig:
        LogGroup: !Ref RetrieveApplicationErrorConfigsFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ApplicationErrorServiceLambdaExcecutionRole.Arn
      Description: Retrieve Application Error Configs.
      Environment:
        Variables:
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          APPLICATION_ERROR_CONFIG_TABLE_NAME: !Ref ApplicationErrorConfigTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/retrieve-applicationerrorconfigs/index.ts

  RetrieveApplicationErrorConfigsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-RetrieveApplicationErrorConfigsFunction"
      RetentionInDays: 365

  UpsertApplicationErrorConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 1
      LoggingConfig:
        LogGroup: !Ref UpsertApplicationErrorConfigFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ApplicationErrorServiceLambdaExcecutionRole.Arn
      Description: Retrieve Application Error Configs.
      Environment:
        Variables:
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          APPLICATION_ERROR_CONFIG_TABLE_NAME: !Ref ApplicationErrorConfigTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/upsert-applicationerrorconfig/index.ts

  UpsertApplicationErrorConfigFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-UpsertApplicationErrorConfigFunction"
      RetentionInDays: 365

  RetrieveApplicationErrorCodesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 1
      LoggingConfig:
        LogGroup: !Ref RetrieveApplicationErrorCodesFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ApplicationErrorServiceLambdaExcecutionRole.Arn
      Description: Retrieve application error codes.
      Environment:
        Variables:
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          APPLICATION_ERROR_CODE_TABLE_NAME: !Ref ApplicationErrorCodeTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/retrieve-applicationerrorcodes/index.ts

  RetrieveApplicationErrorCodesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-RetrieveApplicationErrorCodesFunction"
      RetentionInDays: 365

  UpsertApplicationErrorCodeFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 1
      LoggingConfig:
        LogGroup: !Ref UpsertApplicationErrorCodeFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ApplicationErrorServiceLambdaExcecutionRole.Arn
      Description: Retrieve application error codes.
      Environment:
        Variables:
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          APPLICATION_ERROR_CODE_TABLE_NAME: !Ref ApplicationErrorCodeTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/upsert-applicationerrorcode/index.ts

  UpsertApplicationErrorCodeFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-UpsertApplicationErrorCodeFunction"
      RetentionInDays: 365

  ResetNonComplianceRuleCountsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 1
      LoggingConfig:
        LogGroup: !Ref ResetNonComplianceRuleCountsFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ConfigServiceLambdaExcecutionRole.Arn
      Description: Retrieve AWS Config compliance rules.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          FILTERED_COMPLIANCE_RULES_PARAM: !Ref FilteredComplianceRulesParamName
          NONCOMPLIANCE_COUNTS_TABLE_NAME: !Ref ConfigNonCompliantRuleCountsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/reset-noncompliancerulecounts/index.ts

  ResetNonComplianceRuleCountsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-ResetNonComplianceRuleCountsFunction"
      RetentionInDays: 365

  DescribeComplianceRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeComplianceRulesFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ConfigServiceLambdaExcecutionRole.Arn
      Description: Retrieve AWS Config compliance rules.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          FILTERED_COMPLIANCE_RULES_PARAM: !Ref FilteredComplianceRulesParamName
          NONCOMPLIANCE_TABLE_NAME: !Ref ConfigNonCompliantRuleTable
          NONCOMPLIANCE_COUNTS_TABLE_NAME: !Ref ConfigNonCompliantRuleCountsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-compliancerules/index.ts

  DescribeComplianceRulesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeComplianceRulesFunction"
      RetentionInDays: 365

  DescribeComplianceRuleDetailsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeComplianceRuleDetailsFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt ConfigServiceLambdaExcecutionRole.Arn
      Description: Retrieve AWS Config compliance rules.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          NONCOMPLIANCE_TABLE_NAME: !Ref ConfigNonCompliantRuleTable
          NONCOMPLIANCE_COUNTS_TABLE_NAME: !Ref ConfigNonCompliantRuleCountsTable
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-compliancerule-details/index.ts

  DescribeComplianceRuleDetailsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeComplianceRuleDetailsFunction"
      RetentionInDays: 365

  DescribeStacksFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeStacksFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Retrieve CF stacks.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-stacks/index.ts

  DescribeStacksFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeStacksFunction"
      RetentionInDays: 365

  DescribeChangesetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeChangesetFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Retrieve CF changeset.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-changeset/index.ts

  DescribeChangesetFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeChangesetFunction"
      RetentionInDays: 365

  ExecuteChangesetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref ExecuteChangesetFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Execute CF changeset.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/execute-changeset/index.ts

  ExecuteChangesetFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-ExecuteChangesetFunction"
      RetentionInDays: 365

  DescribeParametersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeParametersFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt SSMParamsLambdaExcecutionRole.Arn
      Description: Retrieve SSM parameters by filters.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-parameters/index.ts

  DescribeParametersFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeParametersFunction"
      RetentionInDays: 365

  UpdateParameterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref UpdateParameterFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt SSMParamsLambdaExcecutionRole.Arn
      Description: Update SSM parameter.
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/update-parameter/index.ts

  UpdateParameterFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-UpdateParameterFunction"
      RetentionInDays: 365

  CreateChangesetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref CreateChangesetFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Creates Cloudformation changeset to update an existing stack for modified SSM params
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/create-changeset/index.ts

  CreateChangesetFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-CreateChangesetFunction"
      RetentionInDays: 365

  DetectStackDriftFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DetectStackDriftFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Requests drift detection of a stack
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/detect-stack-drift/index.ts

  DetectStackDriftFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DetectStackDriftFunction"
      RetentionInDays: 365

  DescribeStackResourceDriftsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 256
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref DescribeStackResourceDriftsFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt CFLambdaExcecutionRole.Arn
      Description: Describes drift detection of a stack
      Environment:
        Variables:
          DEBUG_ENABLED: true
          ALLOWED_CORS_DOMAINS: !Ref AllowedCorsDomains
          AUDIT_TOPIC_ARN: !Ref AuditSNSTopic
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/describe-stack-resource-drifts/index.ts

  DescribeStackResourceDriftsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-DescribeStackResourceDriftsFunction"
      RetentionInDays: 365

  WriteAuditFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ./
      Handler: index.handler
      Runtime: nodejs18.x
      Architectures:
        - x86_64
      MemorySize: 128
      Timeout: 100
      AutoPublishAlias: prod
      DeploymentPreference:
        Type: AllAtOnce
      ReservedConcurrentExecutions: 5
      LoggingConfig:
        LogGroup: !Ref WriteAuditFunctionLogGroup
        LogFormat: JSON
        ApplicationLogLevel: !Ref AppLoggingLevel
        SystemLogLevel: !Ref SystemLogLevel
      Role: !GetAtt BasicLambdaExcecutionRole.Arn
      Description: Requests drift detection of a stack
      Environment:
        Variables:
          DEBUG_ENABLED: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: false
        Target: 'es2020'
        Sourcemap: true
        EntryPoints:
          - src/application/handlers/write-audit/index.ts

  WriteAuditFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-WriteAuditFunction"
      RetentionInDays: 365

  CWLogGroupApiGwAccessLogs:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join ["", ["API-Gateway-Access-Logs_", !Sub "${AWS::StackName}"]]
      RetentionInDays: 365

  RetrieveApplicationErrorConfigsFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "RetrieveApplicationErrorConfigsFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"

  UpsertApplicationErrorConfigFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "UpsertApplicationErrorConfigFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"

  RetrieveApplicationErrorCodesFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "RetrieveApplicationErrorCodesFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"

  UpsertApplicationErrorCodeFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "UpsertApplicationErrorCodeFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"

  DescribeStacksFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeStacksFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"

  DescribeParametersFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeParametersFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}


  UpdateParameterFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "UpdateParameterFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  CreateChangesetFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "CreateChangesetFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  ExecuteChangesetFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "ExecuteChangesetFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DescribeChangesetFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeChangesetFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DetectStackDriftFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DetectStackDriftFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DescribeStackDriftsFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeStackResourceDriftsFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DescribeComplianceRulesFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeComplianceRulesFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DescribeComplianceRuleDetailsFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "DescribeComplianceRuleDetailsFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  ResetComplianceRuleCountsFunctionApiGatewayInvoke:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref "ResetNonComplianceRuleCountsFunction.Alias"
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${DevopsToolkitApi}/*"
      SourceAccount: !Sub ${AWS::AccountId}

  DevopsToolkitApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      EndpointConfiguration: REGIONAL
      MinimumCompressionSize: 0
      TracingEnabled: true
      DisableExecuteApiEndpoint: true
      OpenApiVersion: 3.0.1
      AccessLogSetting:
        DestinationArn: !GetAtt CWLogGroupApiGwAccessLogs.Arn
        Format: >
          {"requestTimeEpoch": $context.requestTimeEpoch, "requestId":"$context.requestId",
          "httpMethod": "$context.httpMethod", "path":"$context.path", "resourcePath": "$context.resourcePath",
          "status": "$context.status",
          "lambdaRequestId": "$context.integration.requestId", "integrationStatus": "$context.integration.status",
          "xrayTraceId": "$context.xrayTraceId", "responseLatency": $context.responseLatency,
          "integrationLatency": "$context.integrationLatency", "error": "$context.error.message",
          "userAgent": "$context.identity.userAgent", "sourceIp": "$context.identity.sourceIp"}
      MethodSettings:
        - HttpMethod: "*"
          ResourcePath: "/*"
          DataTraceEnabled: false
          MetricsEnabled: true # Enable detailed metrics (error 404, latence, ...)
          ThrottlingRateLimit: 10
          ThrottlingBurstLimit: 10
          LoggingLevel: ERROR
      DefinitionBody:
        openapi: "3.0.1"
        info:
          title: !Sub "${AWS::StackName}-api"
          version: "2021-06-10T02:04:23Z"
        paths:
          /app-error-configs:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${RetrieveApplicationErrorConfigsFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpsertApplicationErrorConfigFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /app-error-codes:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${RetrieveApplicationErrorCodesFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpsertApplicationErrorCodeFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /config-rules:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeComplianceRulesFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /config-rules/non-compliant/counts:
            post:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ResetNonComplianceRuleCountsFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /config-rules/{ruleName}:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeComplianceRuleDetailsFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
          /stacks:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeStacksFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /stacks/{stackName}/drift:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeStackResourceDriftsFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DetectStackDriftFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /changesets:
            post:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CreateChangesetFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /changesets/{changeSetId}:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeChangesetFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            post:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: { }
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ExecuteChangesetFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"

          /parameters:
            get:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: {}
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DescribeParametersFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            put:
              security:
                - DevopsToolkitUser: [ ]
              produces:
                - "application/json"
              responses:
                "200":
                  description: "200 response"
                  headers:
                    Strict-Transport-Security:
                      schema:
                        type: "string"
                    Access-Control-Allow-Origin:
                      schema:
                        type: "string"
                  content: {}
              x-amazon-apigateway-integration:
                httpMethod: "POST"
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${UpdateParameterFunction.Arn}:prod/invocations"
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                passthroughBehavior: "when_no_match"
                contentHandling: "CONVERT_TO_TEXT"
                type: "aws_proxy"
            options:
              consumes:
                - "application/json"
              produces:
                - "application/json"
              responses:
                "200":
                  headers:
                    Access-Control-Allow-Origin:
                      type: "string"
                    Access-Control-Allow-Methods:
                      type: "string"
                    Access-Control-Allow-Headers:
                      type: "string"
                    Strict-Transport-Security:
                      type: "string"
                    X-Frame-Options:
                      type: "string"
                    Content-Security-Policy:
                      type: "string"
              x-amazon-apigateway-integration:
                responses:
                  default:
                    statusCode: "200"
                    responseParameters:
                      method.response.header.Access-Control-Allow-Methods: "'GET,POST,PATCH,PUT,DELETE,OPTIONS'"
                      method.response.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
                      method.response.header.Access-Control-Allow-Origin: "'*'"
                      method.response.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
                      method.response.header.X-Frame-Options: "'DENY'"
                      method.response.header.Content-Security-Policy: "'default-src \"none\"; frame-ancestors \"none\"'"
                requestTemplates:
                  application/json: "{\"statusCode\": 200}"
                passthroughBehavior: "when_no_match"
                type: "mock"
        securityDefinitions:
          DevopsToolkitUser:
            type: "apiKey"
            name: "Authorization"
            in: "header"
            x-amazon-apigateway-authtype: "cognito_user_pools"
            x-amazon-apigateway-authorizer:
              providerARNs:
                - Fn::ImportValue: !Sub ${LoginCFStackName}:UserPool:Arn
              type: "cognito_user_pools"
        x-amazon-apigateway-gateway-responses:
          DEFAULT_5XX:
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,OPTIONS,POST'"
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Max-Age: "'86400'"
              gatewayresponse.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
          DEFAULT_4XX:
            responseParameters:
              gatewayresponse.header.Access-Control-Allow-Methods: "'GET,OPTIONS,POST'"
              gatewayresponse.header.Access-Control-Allow-Origin: "'*'"
              gatewayresponse.header.Access-Control-Allow-Headers: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
              gatewayresponse.header.Access-Control-Max-Age: "'86400'"
              gatewayresponse.header.Strict-Transport-Security: "'max-age=31536000; includeSubdomains; preload'"
        x-amazon-apigateway-minimum-compression-size: 0

  ApiGwExecutionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub API-Gateway-Execution-Logs_${DevopsToolkitApi}/Prod
      RetentionInDays: 30

  ApiBasePathMappingv2:
    Type: AWS::ApiGatewayV2::ApiMapping
    Properties:
      DomainName: !Sub "api.${Route53AppDomainName}"
      ApiId: !Ref DevopsToolkitApi
      Stage: !Ref DevopsToolkitApi.Stage
      ApiMappingKey: "toolkit/v1"

  ApiGwWafAssoc:
    DependsOn: DevopsToolkitApiProdStage # An undocumented convention which can solve dependency issue; cf-lint though doesn't like this
    Type: AWS::WAFv2::WebACLAssociation
    Properties:
      WebACLArn: !GetAtt ApiWAF.Arn
      ResourceArn: !Sub 'arn:aws:apigateway:${AWS::Region}::/restapis/${DevopsToolkitApi}/stages/${DevopsToolkitApi.Stage}'

  WhitelistIPSet:
    Type: AWS::WAFv2::IPSet
    Properties:
      Addresses: !Ref WhitelistIPs
      Description: IP addresses to whitelist
      IPAddressVersion: IPV4
      Name: !Sub ${AWS::StackName}-WhitelistIPs
      Scope: REGIONAL

  # Enable for prod or public envts. Extra charges apply
  ApiWAF:
    Type: AWS::WAFv2::WebACL
    Properties:
      DefaultAction:
        Allow: {}
      Scope: REGIONAL
      VisibilityConfig:
        CloudWatchMetricsEnabled: true
        MetricName: AllowedRequests
        SampledRequestsEnabled: true
      Description: Devops Toolkit API Web application Firewall
      Name: !Sub ${AWS::StackName}
      Rules:
        - Name: Custom-Geoblock
          Priority: 1
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: Custom-Geoblock
          Statement:
            AndStatement:
              Statements:
                - NotStatement:
                    Statement:
                      GeoMatchStatement:
                        CountryCodes: [NZ,AU] # Geo-blocking to sample countries (max 2)
                - NotStatement:
                    Statement:
                      IPSetReferenceStatement:
                        Arn: !GetAtt WhitelistIPSet.Arn
          Action:
            Block: {}
        - Name: Custom-FloodRateBasedRule
          Priority: 3
          Statement:
            RateBasedStatement:
              Limit: 1000
              AggregateKeyType: IP
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-FloodRateBasedRule-WAFv2
        - Name: AWSMR-CommonRules-WAFv2 #AWSMR = AWS Managed Rules
          Priority: 5
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-CommonRules-WAFv2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesCommonRuleSet
              ExcludedRules:
                - Name: NoUserAgent_HEADER
                - Name: SizeRestrictions_BODY
        - Name: AWSMR-AdminProtection-WAFv2
          Priority: 6
          OverrideAction:
            Count: {} #keep this on count
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-AdminProtection-WAFv2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesAdminProtectionRuleSet
        - Name: AWSMR-KnownBadInputs-WAFv2
          Priority: 7
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-BadInputs-WAFv2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
        - Name: AWSMR-IpReputation-WAFv2
          Priority: 8
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-IpReputation-WAFv2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesAmazonIpReputationList
        - Name: AWSMR-SQLiRuleSet-WAFv2
          Priority: 9
          OverrideAction:
            None: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: AWSMR-SQLiRuleSet-WAFv2
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesSQLiRuleSet

  WafLoggingConfig:
    Type: AWS::WAFv2::LoggingConfiguration
    Properties:
      LogDestinationConfigs:
        - !Sub 'arn:aws:s3:::aws-waf-logs-ap-southeast-2-${AWS::AccountId}-tbs-${Environment}'
      ResourceArn: !GetAtt ApiWAF.Arn

Outputs:
  ApiId:
    Description: "API Gateway Id"
    Value: !Ref DevopsToolkitApi
    Export:
      Name: !Sub '${AWS::StackName}:DevopsToolkitApi:Id'

  ApiEndpoint:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${DevopsToolkitApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"